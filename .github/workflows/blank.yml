name: Build Rule Sets (SRS + MRS)



on:

  push:

    branches:

      - main

    paths:

      - '**.json'

  workflow_dispatch:



permissions:

  contents: write



jobs:

  build:

    runs-on: ubuntu-latest

    

    steps:

      - name: Checkout repository

        uses: actions/checkout@v4

        with:

          token: ${{ secrets.GITHUB_TOKEN }}



      - name: Download sing-box (Pre-release)

        env:

          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        run: |

          LATEST_TAG=$(gh api repos/SagerNet/sing-box/releases --jq '.[0].tag_name')

          VERSION=${LATEST_TAG#v}

          echo "ğŸ“¦ Downloading sing-box version: $VERSION"

          wget -q "https://github.com/SagerNet/sing-box/releases/download/${LATEST_TAG}/sing-box-${VERSION}-linux-amd64.tar.gz"

          tar -xzf "sing-box-${VERSION}-linux-amd64.tar.gz"

          sudo mv "sing-box-${VERSION}-linux-amd64/sing-box" /usr/local/bin/

          sing-box version



      - name: Download mihomo

        env:

          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        run: |

          # === ä¿®å¤é‡ç‚¹ ===

          # ä¸å†çŒœæµ‹æ–‡ä»¶åï¼Œè€Œæ˜¯ç›´æ¥ç­›é€‰ assets åˆ—è¡¨

          # é€»è¾‘ï¼šæŸ¥æ‰¾åŒ…å« "linux-amd64" ä¸”ä»¥ ".gz" ç»“å°¾ï¼ŒåŒæ—¶ä¸åŒ…å« "compatible" (æ—§æ¶æ„) çš„æ–‡ä»¶é“¾æ¥

          DOWNLOAD_URL=$(gh api repos/MetaCubeX/mihomo/releases --jq '.[0].assets[] | select(.name | contains("linux-amd64") and (contains("compatible")|not) and endswith(".gz")) | .browser_download_url' | head -n 1)

          

          echo "â¬‡ï¸ Downloading from: $DOWNLOAD_URL"

          

          # ä¸‹è½½å¹¶é‡å‘½åä¸ºç»Ÿä¸€åç§°ï¼Œæ–¹ä¾¿åç»­å¤„ç†

          wget -q -O mihomo.gz "$DOWNLOAD_URL"

          

          # è§£å‹

          gunzip mihomo.gz

          

          # æˆæƒå¹¶ç§»åŠ¨

          chmod +x mihomo

          sudo mv mihomo /usr/local/bin/mihomo

          

          # éªŒè¯

          mihomo -v



      - name: Compile rule sets

        run: |

          mkdir -p release_files

          

          find . -name "*.json" -not -path "./.*" | while read json_file; do

            filename=$(basename "$json_file" .json)

            echo "------------------------------------------------"

            echo "ğŸš€ æ­£åœ¨å¤„ç†: $filename"

            

            # 1. sing-box SRS

            sing-box rule-set compile "$json_file" -o "release_files/${filename}.srs"

            echo "âœ… å·²ç”Ÿæˆ sing-box SRS"

            

            # 2. Mihomo Domain MRS

            temp_domain="temp_domain.yaml"

            echo "payload:" > "$temp_domain"

            jq -r '.rules[].domain_suffix[]? // empty' "$json_file" | sed "s/^/  - '+./" | sed "s/$/'/" >> "$temp_domain"

            jq -r '.rules[].domain[]? // empty' "$json_file" | sed "s/^/  - '/" | sed "s/$/'/" >> "$temp_domain"

            

            if [ $(grep -c "  - " "$temp_domain") -gt 0 ]; then

              mihomo convert-ruleset domain yaml "$temp_domain" "release_files/${filename}.mrs"

              echo "âœ… å·²ç”Ÿæˆ Mihomo Domain MRS"

            fi



            # 3. Mihomo IP MRS

            temp_ip="temp_ip.yaml"

            echo "payload:" > "$temp_ip"

            jq -r '.rules[].ip_cidr[]? // empty' "$json_file" | sed "s/^/  - '/" | sed "s/$/'/" >> "$temp_ip"

            

            if [ $(grep -c "  - " "$temp_ip") -gt 0 ]; then

              mihomo convert-ruleset ipcidr yaml "$temp_ip" "release_files/${filename}-ip.mrs"

              echo "âœ… å·²ç”Ÿæˆ Mihomo IP MRS"

            fi

            

            rm -f "$temp_domain" "$temp_ip"

          done



      - name: Delete existing release

        env:

          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        run: |

          gh release delete latest --yes --cleanup-tag || true



      - name: Create Release

        env:

          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        run: |

          gh release create latest \

            --title "Rule Sets (Auto Updated)" \

            --notes "ğŸ• æœ€åæ›´æ–°: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') CST

            

            ## ğŸ“‹ æ–‡ä»¶åˆ—è¡¨

            $(ls -1 release_files/ | sed 's/^/- /')" \

            release_files/*



      - name: Commit and push

        run: |

          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          git config --local user.name "github-actions[bot]"

          

          mkdir -p ./compiled_rules/

          cp release_files/* ./compiled_rules/

          

          git add ./compiled_rules/*

          if git diff --staged --quiet; then

            echo "No changes to commit"

          else

            git commit -m "Auto-build: Update SRS/MRS $(date +'%Y-%m-%d %H:%M')"

            git push

          fi
